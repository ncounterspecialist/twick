name: Build & Publish @twick/render-server Docker image

permissions:
  contents: read
  packages: write

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag for Docker image (e.g., 0.15.0 or latest)'
        required: false
        default: 'latest'
        type: string

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push @twick/render-server image to GHCR
        run: |
          set -euo pipefail

          OWNER="${{ github.repository_owner }}"
          VERSION="${{ inputs.version || 'latest' }}"

          PKG_DIR="packages/render-server"
          PKG_JSON="$PKG_DIR/package.json"

          if [ ! -f "$PKG_JSON" ]; then
            echo "package.json not found at $PKG_JSON"
            exit 1
          fi

          PKG_NAME=$(jq -r '.name' "$PKG_JSON")
          IMAGE_NAME=$(echo "$PKG_NAME" | sed -E 's#^@[^/]+/##')

          echo "Building $PKG_NAME from $PKG_DIR/Dockerfile → ghcr.io/$OWNER/$IMAGE_NAME:$VERSION"

          docker buildx build \
            --platform linux/amd64 \
            --file "$PKG_DIR/Dockerfile" \
            --tag "ghcr.io/$OWNER/$IMAGE_NAME:$VERSION" \
            --label "org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}" \
            --label "org.opencontainers.image.version=$VERSION" \
            --label "org.opencontainers.image.revision=${{ github.sha }}" \
            --push \
            "$PKG_DIR"

          echo "✓ Successfully built and pushed ghcr.io/$OWNER/$IMAGE_NAME:$VERSION"

