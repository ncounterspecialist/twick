name: Deploy Docker Images

permissions:
  contents: read
  packages: write

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag for Docker images (e.g., 0.14.0 or latest)'
        required: false
        default: 'latest'
        type: string

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push cloud-functions images to GHCR
        run: |
          set -euo pipefail
          OWNER="${{ github.repository_owner }}"
          VERSION="${{ inputs.version || 'latest' }}"

          echo "Scanning cloud-functions packages..."
          for dir in packages/cloud-functions/*; do
            [ -d "$dir" ] || continue
            if [ -f "$dir/platform/aws/Dockerfile" ]; then
              pkg_json="$dir/package.json"
              if [ -f "$pkg_json" ]; then
                pkg_name=$(jq -r '.name' "$pkg_json")
                # Derive image repo name from package name (drop scope if present)
                image_name=$(echo "$pkg_name" | sed -E 's#^@[^/]+/##')

                # Build context is the package root; Dockerfile is platform/aws/Dockerfile
                echo "Building $pkg_name → ghcr.io/$OWNER/$image_name:$VERSION"

                docker buildx build \
                  --file "$dir/platform/aws/Dockerfile" \
                  --tag "ghcr.io/$OWNER/$image_name:$VERSION" \
                  --label "org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}" \
                  --label "org.opencontainers.image.version=$VERSION" \
                  --label "org.opencontainers.image.revision=${{ github.sha }}" \
                  --push \
                  "$dir"
                
                echo "✓ Successfully built and pushed $pkg_name"
              else
                echo "Warning: Missing package.json in $dir; skipping"
              fi
            else
              echo "No AWS Dockerfile in $dir; skipping"
            fi
          done

