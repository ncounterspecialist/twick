name: Deploy Docker Images

permissions:
  contents: read
  packages: write

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag for Docker images (e.g., 0.14.0 or latest)'
        required: false
        default: 'latest'
        type: string

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push cloud-functions images to GHCR
        run: |
          set -euo pipefail
          OWNER="${{ github.repository_owner }}"
          VERSION="${{ inputs.version || 'latest' }}"
          CLOUD_ROOT="packages/cloud-functions"

          echo "Scanning Dockerfiles under $CLOUD_ROOT..."
          mapfile -t dockerfiles < <(find "$CLOUD_ROOT" -name Dockerfile -type f | sort)
          if [ "${#dockerfiles[@]}" -eq 0 ]; then
            echo "No Dockerfiles found under $CLOUD_ROOT; nothing to build"
            exit 0
          fi

          for dockerfile in "${dockerfiles[@]}"; do
            pkg_dir="$(dirname "$dockerfile")"
            while true; do
              if [ -f "$pkg_dir/package.json" ]; then
                break
              fi
              if [ "$pkg_dir" = "$CLOUD_ROOT" ] || [ "$pkg_dir" = "." ] || [ "$pkg_dir" = "/" ]; then
                break
              fi
              pkg_dir="$(dirname "$pkg_dir")"
            done

            pkg_json="$pkg_dir/package.json"
            if [ ! -f "$pkg_json" ]; then
              echo "Warning: package.json not found for $dockerfile; skipping"
              continue
            fi

            pkg_name=$(jq -r '.name' "$pkg_json")
            image_name=$(echo "$pkg_name" | sed -E 's#^@[^/]+/##')

            echo "Building $pkg_name from $dockerfile → ghcr.io/$OWNER/$image_name:$VERSION"

            docker buildx build \
              --file "$dockerfile" \
              --tag "ghcr.io/$OWNER/$image_name:$VERSION" \
              --label "org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}" \
              --label "org.opencontainers.image.version=$VERSION" \
              --label "org.opencontainers.image.revision=${{ github.sha }}" \
              --push \
              "$pkg_dir"

            echo "✓ Successfully built and pushed $pkg_name"
          done

